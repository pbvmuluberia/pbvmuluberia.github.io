<!DOCTYPE html>
<html>

<head>
  <link rel="manifest" href="../../../../manifest.json">

  <link rel="apple-touch-icon" href="./src/icons/icon-192x192.png">
  <meta name="apple-mobile-web-app-status-bar" id="meta-apple-status-bar" content="#bf530c">
  <meta name="theme-color" id="meta-theme-color" content="#bf530c">

  <script src="../../script/theme-pwa.js"></script>
  <title>Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Assuming qrcodejs is used elsewhere, kept for compatibility -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    (function () {
      // 1. Restore Theme immediately
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-theme');
      }

      // 2. Restore Language immediately
      window.savedLang = localStorage.getItem('language') || 'bn';
    })();
  </script>

  <style type="text/css" media="print">
    body * {
      visibility: hidden;
    }

    .printable-section,
    .printable-section * {
      visibility: visible;
    }
  </style>

  <!-- Global Styles (Assumed to contain :root variables) -->
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/navbar.css">
  <!-- Page Specific Styles (Updated below) -->
  <link rel="stylesheet" href="../../css/results.css">

  <!-- Scripts (Assuming these local paths are correct) -->
  <script src="../../script/components.js" defer></script>
  <script src="../../script/data.js" defer></script>
  <script src="../../script/utils.js" defer></script>
  <script src="../../script/init.js" defer></script>

</head>

<body>
  <!-- Navbar Placeholder -->
  <nav class="menu">
    <img src="https://raw.githubusercontent.com/t4saha/PBVM-Uluberia-Vigyan-Kendra/main/Logo/pvbm_logo_gold.png"
      alt="Logo" class="nav-logo"
      onerror="this.onerror=null; this.src='https://placehold.co/50x50/d79921/3c3836?text=LOGO'">

    <div class="menu-controls-mobile">
      <span class="menu-label-text" data-translate-key="nav_menu">Menu</span>
      <button class="hamburger-menu" id="hamburgerBtn" onclick="toggleMenu()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <span class="menu-label-text current-menu-label" id="currentMenuLabel"
        data-translate-key="nav${activePageID}">Menu</span>
    </div>
    <div class="nav-links" id="navLinks">
      <a href="../../../../index.html" class="${isActive(menu_home)}" data-translate-key="nav_home">Home</a>
      <a href="./results.html" class="active-tab" data-translate-key="nav_result">Result</a>
      <a href="../aviksha/aviksha_25_rank.html" class="${isActive(menu_home)}" data-translate-key="nav_rank">Rank</a>
    </div>

    <div class="header-controls">
      <button id="themeToggleIcon" onclick="toggleTheme()" class="theme-icon-button">
        <i class="fa-solid fa-sun theme-icon sun-icon"></i>
        <i class="fa-solid fa-moon theme-icon moon-icon"></i>
      </button>
      <div class="lang-toggle">
        <span id="langEn" onclick="setLang('en')">EN</span>
        <span id="langBn" onclick="setLang('bn')">বা</span>
      </div>
    </div>
  </nav>

  <div class="results-container">
    <div class="results-header">
      <h1 data-translate-key="exam">Howrah Zilla Vigyan Manosikata-o-Medha Aviksha</h1>
      <h3 data-translate-key="uluberia">Uluberia Vigyan Kendra</h3>
    </div>

    <div class="search-form-card">
      <div class="input-group">
        <div style="align-self: right;">
          <label data-translate-key="roll_number_label" for="rollNoInput">Enter Roll Number:</label>
          <input data-translate-key="roll_number_placeholder" type="text" id="rollNoInput" placeholder="e.g., UL/01001"
            required>
        </div>
        <div style="align-self: right;">
          <label data-translate-key="year_label" for="yearInput">Enter Year:</label>
          <input data-translate-key="year_placeholder" type="text" id="yearInput" placeholder="e.g., 2024" required>
        </div>
        <div class="btn-group" style="display: flex; gap: var(--space-sm);">
          <button id="searchBtn" class="donate-btn"
            style="align-self: center; border-radius: var(--border-radius-medium); padding: var(--space-sm) var(--space-md);"
            onclick="searchData()" data-translate-key="search_result_button">Search Result</button>
          <button class="donate-btn"
            style="align-self: center; border-radius: var(--border-radius-medium); padding: var(--space-sm) var(--space-md);"
            onclick="window.print();" data-translate-key="print_result_button">Print</button>
        </div>
      </div>

      <div id="result-display" data-translate-key="default_result_display">
        Please enter your Roll Number above and click Search Result to view your performance.
      </div>
    </div>

    <script>
      // *** YOUR DEPLOYED WEB APP EXECUTION URL ***
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxhSsq4NAqhHmMLcO1Dj2hrZHxE6l3rTkv0Go8NYDhp7-V5SfQ_mwdsGvuQXBH8reA84w/exec";

      const resultDiv = document.getElementById('result-display');

      async function searchData() {
        // 1. GET ELEMENTS
        const yearInput = document.getElementById('yearInput');
        const rollNoInput = document.getElementById('rollNoInput');
        const searchBtn = document.getElementById('searchBtn'); // Get the button
        const resultDiv = document.getElementById('result-display');

        const year = yearInput.value.trim();
        const rollNo = rollNoInput.value.trim();

        // Clear previous formatting
        resultDiv.className = '';
        const rollRegex = /^[U][L]\/\d{5}$/;
        const yearRegex = /^\d{4}$/;

        // 2. VALIDATION (Do not disable button yet)
        if (!year || !yearRegex.test(year)) {
          resultDiv.setAttribute('data-translate-key', 'enter_valid_year');
          resultDiv.innerHTML = 'Please enter a valid 4-digit Year. e.g., 2024';
          resultDiv.className = 'error';
          if (window.applyTranslations) window.applyTranslations();
          return;
        }

        if (!rollNo || !rollRegex.test(rollNo)) {
          resultDiv.setAttribute('data-translate-key', 'enter_roll_number');
          resultDiv.innerHTML = 'Please enter a valid Roll Number. e.g., UL/12345';
          resultDiv.className = 'error';
          if (window.applyTranslations) window.applyTranslations();
          return;
        }

        // 3. DISABLE BUTTON & SHOW LOADER
        searchBtn.disabled = true; // Disable the button

        resultDiv.removeAttribute('data-translate-key');
        resultDiv.innerHTML = '<div class="loader"></div>';

        const fullUrl = `${WEB_APP_URL}?rollNo=${encodeURIComponent(rollNo)}&year=${encodeURIComponent(year)}`;

        try {
          const response = await fetch(fullUrl, {
            method: 'GET',
            mode: 'cors',
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();

          if (data.status === 'success' && data.data && data.data.length > 0) {
            const student = data.data[0];

            const lang = getLang();

            const outputHTML = `
              <div class="result-success-content printable-section">
                  <table>
                      <thead>
                          <tr>
                              <th colspan="2" class="table-header"><span data-translate-key="result_header">Howrah Zilla Vigyan Manosikata-o-Medha Aviksha - </span>${year}</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td data-translate-key="roll">Roll Number:</td>
                              <td>${student.roll}</td>
                          </tr>
                          <tr>
                              <td data-translate-key="name">Name:</td>
                              <td>${student.name}</td>
                          </tr>
                          <tr>
                              <td data-translate-key="class">Class:</td>
                              <td>${student.class}</td>
                          </tr>
                          <tr>
                              <td data-translate-key="school">School:</td>
                              <td>${student.school}</td>
                          </tr>
                          <tr class="highlight-row">
                              <td data-translate-key="marks">Marks:</td>
                              <td class="result-value">${student.marks} / 100</td>
                          </tr>
                          <tr class="highlight-row">
                              <td data-translate-key="grade">Grade:</td>
                              <td class="grade-highlight result-value">${student.grade}</td>
                          </tr>
                      </tbody>
                  </table>
              </div>`;

            resultDiv.innerHTML = outputHTML;
            resultDiv.className = 'success';

          } else if (data.status === 'not_found') {
            resultDiv.innerHTML = '<div data-translate-key="not_found">❌ Roll Number not found in the sheet.</div>';
            resultDiv.className = 'error';
          } else if (data.status === 'error') {
            resultDiv.innerHTML = '<div data-translate-key="error_found">❌ Result is not available for this year.</div>';
            resultDiv.className = 'error';
          } else {
            const lang = getLang();
            const template = window.translations[lang]['api_error'] || window.translations['en']['api_error'];
            const finalMessage = template.replace('${data.message}', data.message);
            resultDiv.innerHTML = finalMessage;
            resultDiv.className = 'error';
          }
        } catch (error) {
          const lang = getLang();
          const template = window.translations[lang]['network_error'] || window.translations['en']['network_error'];
          const finalMessage = template.replace('${error.message}', error.message);

          resultDiv.innerHTML = finalMessage;
          resultDiv.className = 'error';
          console.error("Fetch Error:", error);
        } finally {
          // 4. RE-ENABLE BUTTON (Runs on both Success and Error)
          searchBtn.disabled = false;
        }

        if (window.applyTranslations) {
          window.applyTranslations();
        }
      }
    </script>
</body>

</html>